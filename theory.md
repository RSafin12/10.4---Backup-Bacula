## Bacula 
Кросс-платформенное, клиент-серверное приложение. 
bacula-dir это основной сервис который управляет всеми другими сервисами по резервному копированию и восстановлению.  
bacula-sd это хранилище предназначенное очевидно для хранения бэкапов. 
bacula-fd это демон, клиентская часть приложения которая нужна для доступа к файлам на сервере, с которого идет бэкапирование. 

### Установка 
`apt install bacula`
Кроме самой bacula нужна и БД, по дефолту используется postgres, для замены БД надо
`sudo alternatives --config libbaccats.so`

можно еще поставить `bacula-doc` это консольная документация-хендбук, можно посмотреть разные examples для разных кейсов. 

### Конфигурирование

#### bacula-sd

Важно! 
`# mkdir /backups/files1/`    создаем директорию куда сложим бэкапы
`# chmod 755 /backups/files1/`   выставляем права доступа
`# chown bacula:bacula /backups/files1/`   назначаем bacula владельцем

Различные компоненты bacula должны авторизовывать друг друга, для этого существует директорива password. Например, пароль в ресурсе Storage файла **/etc/bacula/bacula-dir.conf** должен соответствовать паролю ресурса Director файла **/etc/bacula/bacula-sd.conf**. 

Основная настройка bacula выполняется в файле 
/etc/bacula/bacula-sd.conf

В настройках есть основные секции
Storage - секция с основными настройками хранилища. Здесь можно настроить имя хранилища, его IP(для локального хранилища localhost 127.0.0.1) 
```
Storage { # definition of myself 
	Name = nodeOne-sd         # имя хранилища  
	SDPort = 9103                    # исходящий порт, который будет смотреть клиент
	WorkingDirectory = "/var/lib/bacula"       # там где будет находится процесс, обеспечивающий работу сервиса    
	Pid Directory = "/run/bacula"              # расположения pid процесса  
	Plugin Directory = "/usr/lib/bacula"     
	Maximum Concurrent Jobs = 20        # максимальное кол-ва задач, т.е. сколько максимум одновременно будет делаться бэкапов
	SDAddress = 127.0.0.1    # адрес хоста хранилища
	}
```

Director настройка авторизации для управляющего узла. Тут нужно указать имя сервиса который может подключиться и пароль, который он должен использовать.   
```
Director { 
	Name = nodeOne-dir 
	Password = "tMLJYlOKqe2U7EAFXJ88O3EWRpfIybO5t"}
```

Device - тут настраивается путь к папке хранения и способ хранения данных
```
Device { 
	Name = brave-stor
	Media Type = File1 
	Archive Device = /backup-week
	LabelMedia = yes; # lets Bacula label unlabeledmedia 
	Random Access = Yes; 
	AutomaticMount = yes; # when device opened, read it 
	RemovableMedia = no; 
	AlwaysOpen = no; 
	Maximum Concurrent Jobs = 5
	}
```

Messages - отправка сообщений, можно оставить как есть. 

После настройки конфига нужно проверить его корректность и перезапустить службу
`systemctl restart bacula` 

#### bacula-fd

`# apt install bacula-fd` весь bacula ставить необязательно, хватит и клиента
`# chmod 644 /etc/bacula/bacula-fd.conf`  выставляем права
`# chown root:bacula /etc/bacula/bacula-fd.conf` ставим владельца

#### bacula-dir 
Важно, в директоре не указываются fd/sd которые могут иницировать подключение, это в fd/sd указывается директор, который  может иницировать процессы бэкапирования. 

Весь конфиг состоит из ресурсов, которые в свою очередь представлены директивами в виде "название = значение" и обрамлены скобками
Основная работа работа по настройке ведется с директивой JobDef, в ней перечислены все остальные директивы, которые будут задействованы далее в работе. Однако сама JobDef лишь описание того, что и в каком виде нужно сделать. На JobDef ссылается Job, которая по факту и отвечает за выполнение бэкапирования/восстановления. 
На самом деле такое дробление на кусочки в виде ресурсов очень удобно тем, что позволяет очень гибко настроить схему бэкапирования. Например, можно сделать так, чтобы Job выполнялась для определенных Client, бэкапируя перечисленные в FileSet директории по какому-то из расписаний в Schedule. Однако по этому же расписанию можно бэкапить другую группу Client с другим FileSet. В общем комбинируя заготовленные русурсы можно получить гибкую систему. 

Для простоты ориентирования можно часть ресурсов вынести в отдельные конфигурационные файлы и сложить например в /etc/bacula/conf.d/test.conf
и далее в dir/sd/fd ссылаться на эти отдельные конфиги 
@/etc/bacula/conf.d/test.conf

Сложнее выглядит концепт Pool, эту абстракцию можно сравить в каком то смысле с LVM. В данном случае мы также добавляем в Pool разные Volume, а они в свою очередь могут быть как физическими носителями или файлами. Это нужно, чтобы не ограничивать хранилище размером какого-либо носителя, а добавлять по необходимости ресурсы. Перед использование Volume нужно маркировать label'ом 

FileSet позволяет определить несколько наборов резервируемых данных. 
Секция Include содержит пути к резервируемым файлам/каталогам, а Exclude – пути к файлам и каталогам, которые необходимо исключить из списка резервируемых. В секции Include возможна секция Options, в которой определяются параметры резервирования.
```
FileSet {
     Name = "Catalog" ### ная конфигурация Хранилища (Main conf)
     Include {
     Options {
     signature = MD5 # алгоритм вычисления контрольных сумм файлов.
     compression = GZIP # алгоритм компрессии файлов.
     aclsupport = yes # 
     recurse = yes # рекурсивное резервирование, т.е. с директориями/файлами 
     xattrsupport = yes # поддержка расширенных атрибутов, это обязательный параметр для работы с метками безопасности.
     
}
     File = /home  # каталог, который мы копируем.
   }
```

На случай, если решено завести отдельную директорию под конфигурацию директив, то нужно выставить соответствующие права доступа
`chmod 755 /etc/bacula/client.d/`
`chown root:bacula /etc/bacula/client.d/`
`chmod 644 /etc/bacula/client.d/*  `
`chown root:bacula /etc/bacula/client.d/*`


### Мой стенд для практики

2 VM
Нода brave - она же мастер, она же сторадж
Нода strong - клиент, которого будем бэкапить 

Для начала надо бы научиться бэкапить сам brave на самого себя. 
В любом случае на сторадже делаем lvm
- /backup-week  для недельных фулл
- /backup-diff     для ежедневных дифф
- /backup-inc      для быстрых инкрементальных 
Разметить ФС и примонтировать куда нить, они станут device в bacula-sd

### Траблшутинг

`bacula-sd -t -c ./bacula-sd.conf` команда проверки корректности конфига, если команда возвращает 0, то все ок. Если сервис не стартует, то лучше проверить этой командой вывод ошибок, т.к. команда укажет на синтакстическую ошибку. Команда есть и для других компонентов, dir, fd. 

## Пилюлька
`echo 'run job=dent yes' | bconsole` 

## Вопросы
А если нужно добавить несколько клиентов для бэкапирования, то каждому нужно создавать секцию Client? Как правильно редактировать секцию Client? 
Допустим я хочу применить job для группы хостов, как мне описать эту группу? 

А как сделать ротацию бэкапов? 

Что такое autochanger? Насколько я понял, это директива позволяющая использовать сразу несколько дисков, чтобы ускорить бэкапирование/восстановление. Грубо говоря распределяет нагрузку между доступными ему девайсами. Но какой в нем смысл, если в данном эксперименте только одно физическое устройство? Дробить на логические сущности нет смысла?  

В различных директивах присутвтует File1 или File2? Что они обозначают? 

как тестируется система? каковы критерии хорошо настроенной системы бэкапирования? мониторинг сервиса бэкапирования, доступного места на хранилище?

Что будет, когда место на хранилище закончится? 
